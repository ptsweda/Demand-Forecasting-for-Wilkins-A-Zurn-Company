---
title: "Strategic Marketing Analysis - Forecasting - Saxa 1"
author: "Braden Donayre"
date: "2024-07-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages & Data

```{r Load Packages & Data}
#Packages
library(ggplot2)
#install.packages('forecast')
library(forecast)
library(grid)
#install.packages('Amelia')
library(Amelia)
library(tseries)
library(scales)
library(gridExtra)
library(lmtest)
library(zoo)
library(Rcpp)
library(readxl)
#install.packages('XLS')
library(XLS)

#Combined Data
combined_data <- read_excel("WILKINS CASE DATA.xls", sheet = "Combined Data", range = "A2:S19")

```

## Exloratory Analysis & Data Preperation

```{r Exploration & Preperation}
head(combined_data)
combined_data$Quarter <- as.Date(combined_data$Quarter, "%m/%d/%Y")
combined_data = combined_data[-1]
head(combined_data)
str(combined_data)
class(combined_data)
summary(combined_data)

hist(combined_data$`Total PVB`)


#### Plots ####
#Plot quarterly sales data to view seasonality for PVB
quarterly_sales_plot_PVB <- ggplot(combined_data, aes(Quarter,`Total PVB`)) + geom_line(na.rm=TRUE) + 
  xlab("Quarter") + ylab("PVB Unit Sales") + 
  scale_x_date(labels = date_format(format= "%b-%Y"),breaks = date_breaks("6 months")) + 
  stat_smooth(colour = "blue")

quarterly_sales_plot_PVB   

#Inferences on PVB plot: 
  #1) There are spikes around April each year, indicating seasonality 
  #2) The magniturde of the variation around the seasonality proportionally increases, indicating multiplicative decomposition would be reasonable approach 


#Plot quarterly sales data to view seasonality for Fire Valve
quarterly_sales_plot_FV <- ggplot(combined_data, aes(Quarter,`Total Fire Valve`)) + geom_line(na.rm=TRUE) + 
  xlab("Quarter") + ylab("FV Unit Sales") + 
  scale_x_date(labels = date_format(format= "%b-%Y"),breaks = date_breaks("6 months")) + 
  stat_smooth(colour = "green")

quarterly_sales_plot_FV  

#Inferences on FV plot: 
  #1) The plot is more smoother than PVB, indicating a trend
  #2) The magnitude stays constant, which would mean an additive decomposition appraoch may be best


### Split combine data into two time series objects for FV total sales and PVB total sales

###PVB###
#Converting data into a time series object for PVB
data_ts_PVB <- ts(combined_data$`Total PVB`, frequency = 4, start = c(year(min(combined_data$Quarter)), quarter(min(combined_data$Quarter))))
class(data_ts_PVB)

#Plot time series with trend line
plot(data_ts_PVB, col = "blue", main = "PVB Sales Time Series Data")
abline(reg=lm(data_ts_PVB~time(data_ts_PVB)), col="lightgray")

# Regression model
reg_PVB <- lm(data_ts_PVB~time(data_ts_PVB))
summary(reg_PVB)

#Autocorrelation and Partial Autocorrelation Plots
Acf(data_ts_PVB)
Pacf(data_ts_PVB)

#Lag plot of Data
gglagplot(data_ts_PVB, set.lags=1:16)
#Ljung-Box test on the first 24 Lag autocorrelations
Box.test(data_ts_PVB, lag=24, fitdf=0, type="Lj")

# # auto_tsd <-ts(auto[,c('DAUTONSA')], frequency=12)
# # class(auto_tsd)
# component.ts = decompose(auto_tsd)
# plot(component.ts)

#For PVB multiplicative decomposition use the following code
component.pvb = decompose(data_ts_PVB, type="multiplicative", filter=NULL)
plot(component.pvb)


###FV###

#Converting data into a time series object for FV
data_ts_FV <- ts(combined_data[,c('Total Fire Valve')], frequency=4)
class(data_ts_FV)
#Plot time series with trend line
plot(data_ts_FV, col = "green", main = "FV Sales Time Series Data")
abline(reg=lm(data_ts_FV~time(data_ts_FV)), col="lightgray")
# Regression model
reg_FV <- lm(data_ts_FV~time(data_ts_FV))
summary(reg_FV)
#Autocorrelation and Partial Autocorrelation Plots
Acf(data_ts_FV)
Pacf(data_ts_FV)
#Lag plot of Data
gglagplot(data_ts_FV, set.lags=1:16)
#Ljung-Box test on the first 24 Lag autocorrelations
Box.test(data_ts_FV, lag=24, fitdf=0, type="Lj")
#For FV Addictive decomposition 
component.fv = decompose(data_ts_FV, type="additive", filter=NULL)
plot(component.fv)



##############4. TEST WHETHER STATIONARY SERIES##############
adf.test(data_ts_PVB)

#Augmented Dickey-Fuller Test
#data:  PVB Time Series
#Dickey-Fuller = -6.6546,, Lag order = 2, p-value =  0.01
#alternative hypothesis: stationary


adf.test(data_ts_FV)

#Augmented Dickey-Fuller Test
#data:  FV Time Series
#Dickey-Fuller = -1.7663,, Lag order = 2, p-value =  0.6614
#alternative hypothesis: stationary
```

## Question 2: Relationship of PVB product family (total) and FV and exogenous variables: unemployment rate, 
## bank prime loand rate and $ of housing starts? How does this relationship affaect PVV productt family? 

```{r Question 2}
# Create a linear regression model for PVBs for all 3 exogenous variables 
PVB_total_lm_model <- lm(`Total PVB` ~ `Unemployment Rate` + `Bank Prime Loan` + `Total`, data = combined_data)
summary(PVB_total_lm_model)
residuals_PVB <- residuals(PVB_total_lm_model)
hist(residuals_PVB, main = "Histogram of PVB Residuals (All Variabes)")   #PVB residuals are not normal 
qqnorm(residuals_PVB, main = "QQ Plot of PVB Residuals (All Variables")
qqline(residuals_PVB)



# Create a linear regression model for PVBs for just 1 exogenious - Total Housing Starts
PVB_total_lm_model_total <- lm(`Total PVB` ~  `Total`, data = combined_data)
residuals_PVB_total <- residuals(PVB_total_lm_model_total)
hist(residuals_PVB_total, main = "Histogram of PVB Residual (Housing Starts)")   #PVB residuals are not normal 
qqnorm(residuals_PVB_total, main = "QQ Plot of PVB Residuals (Housing Starts")
qqline(residuals_PVB_total)



# Create a linear regression model for FV
FV_total_lm_model <- lm(`Total Fire Valve` ~ `Unemployment Rate` + `Bank Prime Loan` + `Total`, data = combined_data)
summary(FV_total_lm_model)



```

##3.	Create a demand forecast for the PVB product family (total) for the next three quarters of 2005. ##

```{r Question 3 Demand forecast }
#To create a demand forecast for the PVB product family, we would need to fit an ARIMA model to the data

data_arima <- auto.arima(data_ts_PVB)
summary(data_arima)

#To generate forecast for the next three quarters of 2005:
forecast_PVB <-forecast(data_arima, h = 3)

#Plot the forecast for the PVB product family (total)
plot(forecast_PVB, main = "PVB Sales Forecast", xlab = "Time", ylab = "Total PVB", col = "blue")
print(forecast_PVB)

# Fit an ETS model to the data
fit_ets <- ets(data_ts_PVB)
summary(fit_ets)

# Forecast for the next three quarters of 2005
forecast_PVB_ets <- forecast(fit_ets, h = 3)

# Plot the forecast
plot(forecast_PVB_ets, main = "PVB Sales Forecast (ETS)", xlab = "Time", ylab = "Total PVB", col = "blue")

# Print forecasted values
print(forecast_PVB_ets)

```

##3A.	What type of trend and seasonal pattern of demand do you find in the data for PVB?. ##

```{r Question 3A Type of trend/ seasonal pattern }

# Decompose the time series
decomposed_pvb <- decompose(data_ts_PVB, type = "multiplicative")
plot(decomposed_pvb)

# Seasonal decomposition using STL (Seasonal and Trend decomposition using Loess)
stl_pvb <- stl(data_ts_PVB, s.window = "periodic")
plot(stl_pvb)

# Extract and plot components
trend <- decomposed_pvb$trend
seasonal <- decomposed_pvb$seasonal
random <- decomposed_pvb$random

par(mfrow = c(3, 1))
plot(trend, main = "Trend Component", col = "blue")
plot(seasonal, main = "Seasonal Component", col = "red")
plot(random, main = "Random Component", col = "green")
par(mfrow = c(1, 1))


```


## 3B.	Can you isolate the trend estimate with a linear regression model with Y = quarterly demand 
## for PVB and X=quarters by year? What is the R-square? Is the model significant?
##  What will you infer from the ## coefficient (Beta) estimate of the regression model?. ##

```{r Question 3B Isolate the trend estimate }
library(lubridate)

#Prepare the data 
combined_data$TimeIndex <- as.numeric(as.yearqtr(combined_data$Quarter))

# Fit the linear regression model
linear_model <- lm(`Total PVB` ~ TimeIndex, data = combined_data)
summary(linear_model)

# Extract the summary of the model
model_summary <- summary(linear_model)

# R-square value
r_squared <- model_summary$r.squared

# Coefficient (Beta) estimate
beta_estimate <- coef(linear_model)["TimeIndex"]

# Print results
cat("R-squared:", r_squared, "\n")
cat("Beta (coefficient) estimate:", beta_estimate, "\n")
cat("Model summary:\n")
print(model_summary)
```

## 3C.What do the ACF and PACF visuals indicate for the PVB product forecast? . ##

```{r Question 3C ACF and PACF visuals }
Acf(forecast_PVB[["fitted"]])
Pacf(forecast_PVB[["fitted"]])

```


##3D.	Compare forecast models##

```{r Question 3D(i). Compare: NaÃ¯ve demand forecast }
naive_forecast <-naive(data_ts_PVB, h=3)
summary(naive_forecast)
autoplot(naive_forecast)
print(naive_forecast)

#Check for fitted values and residuals
checkresiduals(naive_forecast)

```


```{r Question 3D(ii). Compare: Moving average (2 quarter) }
# Moving average forecast (2 quarter)
ma_forecast <- forecast::ma(data_ts_PVB, order = 2)
print("Moving Average (2 Quarter) Forecast:")
print(ma_forecast)

```



```{r Question 3D(iii). ARIMA model }

# Fit ARIMA model
arima_model <- forecast::auto.arima(data_ts_PVB)
arima_forecast <- forecast::forecast(arima_model, h = 3)
print("ARIMA Forecast:")
print(arima_forecast)

```


```{r Question 3D(iv). Compare Arima model with estimate of current focasting }
#current model: 
forecast_PVB_ets

#Moving average forecast
ma_forecast
#Naive
naive_forecast

#Arima model: 
arima_forecast


#Plotting the forecast comparison between current and all other models: Naive, Arima and Moving avg)
autoplot(forecast_PVB_ets)+     #current forecast
  autolayer((ma_forecast),series="Moving Average", PI=FALSE)+
  autolayer((naive_forecast),series="Naive", PI=FALSE)+
  autolayer((arima_forecast),series="ARIMA", PI=FALSE)+
  labs(title = "Comparison Forecast for PVB Product Family", x="Time (Qtr)", y= "Demand in Units")+
  guides(colour= guide_legend(title="Forecast Method"))+
  theme_minimal()

```


```{r Question 3D(v). Product family or individual producsts }


```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
